"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.packSingleHtml=void 0;const t=e(require("fs")),s=e(require("path"));function c(e,n,r=!0){t.default.existsSync(n)||t.default.mkdirSync(n,{recursive:!0});const i=t.default.readdirSync(e);for(const o of i){const i=s.default.join(e,o),l=s.default.join(n,o),a=t.default.statSync(i);a.isFile()?t.default.copyFileSync(i,l):r&&a.isDirectory()&&c(i,l,r)}}function n(e,t){return e.replace("System.register([",`System.register("chunks:///${t}",[`)}function r(e,s,c){let r=t.default.readFileSync(e,{encoding:"utf8"});r=n(r,s),c&&(r=c(r)),t.default.writeFileSync(e,r,"utf8")}function i(e,c,r){const o=t.default.readdirSync(`${e}/${c}`,{withFileTypes:!0});for(const l of o){const o=`${c}/${l.name}`;if(l.isFile()){const c=`${e}/${o}`;switch(s.default.extname(o)){case".js":let e=t.default.readFileSync(c,{encoding:"utf8"});e=n(e,l.name),t.default.writeFileSync(c,e,"utf8"),r.push(o);break;case".wasm":const s=t.default.readFileSync(c),i=Buffer.from(s).toString("base64");t.default.rmSync(c);const a=o.replace("cocos-js/","");t.default.writeFileSync(c+".js",`if(window.wasmMap==null) window.wasmMap = {}; window.wasmMap["${a}"]="${i}";`,"utf8"),r.push(o+".js")}}else l.isDirectory()&&i(e,o,r)}}function o(e,s){let c=t.default.readFileSync(e,{encoding:"utf8"});c=n(c,s),t.default.writeFileSync(e,c,"utf8")}exports.packSingleHtml=function(e,n,l,a,p){r(`${e}/index.js`,"index.js"),r(`${e}/application.js`,"application.js",(e=>(e=(e=e.replace("src/settings.json","")).replace("src/effect.bin","")).replace("cc = engine;",'\n    cc = engine;\n    System.import("chunks:///downloadHandle.js");\n    cc.settings._settings = window.cocosSettings;\n    // cc.effectSettings._data = ArrayBuffer;\n    '))),c(`${s.default.dirname(__dirname)}/assets`,`${e}`,!1);const u=function(e,s){let c=t.default.readFileSync(e,{encoding:"utf8"}),n=JSON.parse(c);return null!=n.splashScreen&&(n.splashScreen.totalTime=0,null!=n.splashScreen.logo&&(n.splashScreen.logo.base64="")),t.default.writeFileSync(s,`cocosSettings=${JSON.stringify(n)}`,"utf8"),t.default.rmSync(e),n.scripting.scriptPackages}(`${e}/src/settings.json`,`${e}/src/settings.js`),f=`${e}/src/import-map.json`;!function(e,t){for(let c of t){let t=c.replace("../","");o(s.default.join(e,"/temp",c),t)}}(e,u);const d=[];i(e,"cocos-js",d),function(e,n,i,o,l,a){let p=t.default.readFileSync(e,{encoding:"utf8"}),u=t.default.readFileSync(n,{encoding:"utf8"});p=p.replace('\x3c!--<link rel="apple-touch-icon" href=".png" />--\x3e',""),p=p.replace('\x3c!--<link rel="apple-touch-icon-precomposed" href=".png" />--\x3e',"");let f="";o&&(p+='<script src="./vconsole.min.js"><\/script>\n<script type="text/javascript">\n    // open web debugger console\n    window.VConsole && (window.vConsole = new VConsole());\n<\/script>'),console.log("scriptPackages",i);for(let e of i)f+=`<script src="${e.replace("../","")}" charset="utf-8"> <\/script>\n`;p=p.replace("\x3c!-- dataJS --\x3e",l?'<script src="data.js" charset="utf-8"> <\/script>\n':""),p=p.replace("\x3c!-- packages scripts --\x3e",`${f}`);const d=u.replace("./../cocos-js/cc.js","chunks:///cc.js");if(p=p.replace('<script type="systemjs-importmap" charset="utf-8"><\/script>',`<script type="systemjs-importmap" charset="utf-8">\n  ${d}\n  <\/script>`),p=p.replace("\x3c!-- Controls --\x3e",a?'<script src="controls/guify.js"><\/script>\n<script src="controls/ControlsGUI.js">\n<\/script><script>System.import("chunks:///ControlsGUI.js");<\/script>':""),a){const t=s.default.join(Editor.Project.path,"preview-template/gui"),n=s.default.join(s.default.dirname(e),"controls");c(t,n),r(`${n}/ControlsGUI.js`,"ControlsGUI.js")}t.default.writeFileSync(e,p,"utf8")}(`${e}/index.html`,f,[...d,...u],l,a,p),t.default.rmSync(f),t.default.rmdirSync(`${e}/assets`,{recursive:!0})};