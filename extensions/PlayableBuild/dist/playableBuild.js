"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.onAfterBuild=exports.onAfterCompressSettings=exports.onBeforeCompressSettings=exports.onBeforeBuild=exports.load=void 0;const t=e(require("archiver")),n=e(require("fs")),s=e(require("path")),o=require("./packSingleHtml"),a="playable-build",i=[".binary",".bin",".dbbin",".skel",".cconb",".mp3",".mp4",".png",".jpg",".jpeg",".webp"],l=[".txt",".xml",".vsh",".fsh",".atlas",".tmx",".tsx",".json",".ExportJson",".plist",".fnt",".ttf",".rt",".mtl",".pmtl",".prefab",".log"],r=[".js",".effect","chunk"],c=["cc.VideoClip","cc.Material","cc.ImageAsset","cc.AudioClip","cc.JsonAsset","dragonBones.DragonBonesAsset","dragonBones.DragonBonesAtlasAsset","sp.SkeletonData","cc.Asset","cc.TTFFont"],f=["cc.Material"],u=["cc.JsonAsset","dragonBones.DragonBonesAsset","dragonBones.DragonBonesAtlasAsset","sp.SkeletonData"],d=["cc.Mesh","cc.Skeleton","cc.Prefab","cc.Material","cc.AnimationClip","cc.Texture2D","cc.ImageAsset"];function p(e,t=!0){let o=0;for(const a of n.default.readdirSync(e)){const i=s.default.join(e,a),l=n.default.statSync(i);l.isFile()?o+=l.size:t&&l.isDirectory()&&(o+=p(i))}return o}function g(...e){return console.log(`[${a}] `,...e)}function y(e,t=[]){const s=n.default.readdirSync(e);for(const o of s){const s=`${e}/${o}`;n.default.statSync(s).isDirectory()?y(s,t):t.push(s)}return t}function m(e,t){const n=s.default.extname(e);return-1!=t.indexOf(n)}function S(e,t){let o=t;n.default.existsSync(t)&&n.default.lstatSync(t).isDirectory()&&(o=s.default.join(t,s.default.basename(e))),n.default.writeFileSync(o,n.default.readFileSync(e))}function h(e,t){if(n.default.existsSync(t)||n.default.mkdirSync(t),n.default.lstatSync(e).isDirectory()){const o=n.default.readdirSync(e);for(const a of o){const o=s.default.join(e,a);n.default.lstatSync(o).isDirectory()?h(o,s.default.join(t,a)):S(o,t)}}}exports.load=async function(){console.log(`[${a}] Load cocos plugin example in builder.`)},exports.onBeforeBuild=async function(e){e.useSplashScreen=!0,e.mainBundleCompressionType="none",g(`${a}`,"onBeforeBuild",e)},exports.onBeforeCompressSettings=async function(e,t){g(`${a}`,"onBeforeCompressSettings",e,t)},exports.onAfterCompressSettings=async function(e,t){g(`${a}`,"onAfterCompressSettings")},exports.onAfterBuild=async function(e,S){const b=e.packages["web-mobile"].embedWebDebugger;g("onAfterBuild",e,S,b),function(e,t){if(!n.default.existsSync(e))return console.error("can not find build template: "+e);g(`${a} copy build-template: `,e),h(e,t)}(Editor.Project.path+"/build-templates/playable",S.dest);let x=`${S.dest}/assets`;const j=await async function(e,t){const o=t.__task.cache.assetUuids,a=new Set(o),p=`${t.dest}/`,g=12,y=t.paths.assets.length+1,S=["json","text","_skeletonJson","_dragonBonesJson","_atlasJson"],h=[],b={},x={},j=function(e,t,n,s,o){(t=t.slice(g)).startsWith("resources")&&(t=t.replace("resources","resource"));const a=B(t,n,s,o);null!=a&&u.includes(e)&&$(a)},B=function(e,t,o=!0,a=!1){if(!n.default.existsSync(t)){if(t=t.replace("\\native\\","\\import\\"),!n.default.existsSync(t))return void console.log("Cocos Bug: can't find file path",e,t);console.log("Cocos Bug: the file path in native which no import",e,t)}const c=t.slice(y).replace(/\\/g,"/");o?a||(e=function(e,t){const n=s.default.basename(e,s.default.extname(e));return s.default.join(s.default.dirname(e),n+t)}(e,s.default.extname(t))):e=s.default.join(s.default.dirname(e),s.default.basename(c)),e=e.replace(/\\/g,"/");const f=p+e;n.default.mkdirSync(s.default.dirname(f),{recursive:!0}),n.default.renameSync(t,f),h.push(f),m(e,i)||m(e,l)||m(e,r)||console.warn("未能识别的文件格式，有可能会导致上传平台运行错误，还请检查该文件正确性:",e);const u="assets/"+c;return b[u]=e,console.log("translateResource",u,f),{filePath:f,resourceKey:u}},$=function(e){const t=n.default.readFileSync(e.filePath,{encoding:"utf8"});try{const s=JSON.parse(t),o=s[3][0][1];if(null==o||!Array.isArray(o))return;const a=o.findIndex((e=>S.includes(e)))+1,i=s[5][0][a];if(a<0&&null==i)return;n.default.writeFileSync(e.filePath,"string"==typeof i?i:JSON.stringify(i),{encoding:"utf8"}),s[5][0][a]="",x[e.resourceKey]=JSON.stringify(s)}catch(e){console.log(e,JSON.parse(t))}};for(const e of a){const n=t.getAssetPathInfo(e);if(null!=n&&0!=n.length)for(const t of n){if(null==t||"internal"==t.bundleName||"main"==t.bundleName)continue;if(null==t.json&&null==t.raw)continue;const n=await Editor.Message.request("asset-db","query-asset-info",e);if(null==n)continue;let s=n.source;if(null==s||""==s){if(n.importer.startsWith("gltf")&&d.includes(n.type)){if(s=n.path,s.startsWith("db://internal/"))continue;if(null!=t.json&&j(n.type,s,t.json,"cc.Prefab"==n.type),null!=t.raw)for(const e of t.raw)j(n.type,s,e,!1)}}else{if(!c.includes(n.type))continue;if(s.startsWith("db://internal/"))continue;const e=null!=t.raw&&t.raw.length>0?t.raw[0]:t.json;j(n.type,s,e,!0,f.includes(n.type))}}}return n.default.writeFileSync(`${t.dest}/dataMap.js`,"assetsKeyMap="+JSON.stringify(b)+"\nmetaDatasMap="+JSON.stringify(x),{encoding:"utf8"}),h}(0,S),B=y(x);let $=function(e,t){const s={},o=e.length+1;for(let e of t){const t=e.slice(o);if(m(e,l)||m(e,r))s[t]=n.default.readFileSync(e,{encoding:"utf8"});else{m(e,i)||console.warn("未能识别的文件格式，有可能会导致上传平台运行错误，还请检查该文件正确性:",e);const o=n.default.readFileSync(e);s[t]=Buffer.from(o).toString("base64")}}return JSON.stringify(s)}(S.dest,B);n.default.writeFileSync(`${S.dest}/assets.js`,"assetsMap="+$,{encoding:"utf8"});const w=e.packages[a];(0,o.packSingleHtml)(S.dest,e.name,b,w.packDataJS,w.packControls),function(e,t){const o=t.settings,a={dataJs:{version:1},mvPlayable:!0,engine:{name:"CocosCreator",version:null==o?void 0:o.CocosEngine,debug:null==o?void 0:o.engine.debug,fileSize:p(s.default.join(t.dest,"cocos-js"))}};n.default.writeFileSync(e,JSON.stringify(a),{encoding:"utf8"})}(`${S.dest}/mvConfig.json`,S),await async function(e,o){n.default.renameSync(`${e}/index.html`,`${e}/${o}.html`);const a=s.default.dirname(e),i=n.default.createWriteStream(s.default.join(a,`${o}.zip`)),l=(0,t.default)("zip",{zlib:{level:9}});l.pipe(i),l.file("index.html",{name:`${o}.html`}),l.directory(e,o),await l.finalize(),n.default.renameSync(`${e}/${o}.html`,`${e}/index.html`)}(S.dest,e.name),w.packPresetTest&&await async function(e,o,a="_preset",i="presets"){const l=s.default.join(e,i);if(!n.default.existsSync(l))return;const r=function(e,t){const o=[],a=n.default.readdirSync(t);for(const i of a){const a=s.default.join(t,i),l=n.default.readdirSync(a);let r="",c=0;for(const e of l){const t=s.default.join(a,e),n=p(t);n>c&&(c=n,r=t)}o.push(s.default.relative(e,r).replace(/\\/g,"/"))}return o}(e,l);if(0==r.length)return;console.log("presetOptisons",r);const c=s.default.dirname(e),f=n.default.createWriteStream(s.default.join(c,`${o}${a}.zip`)),u=(0,t.default)("zip",{zlib:{level:9}});u.pipe(f),u.directory(e,o,(e=>!(e.name.startsWith(i)&&!r.find((t=>e.name.startsWith(t))))&&e)),await u.finalize()}(S.dest,e.name);const A=`${S.dest}/`.length;if(e.packages[a].packDataJS){let e=function(e,t){const s={};for(const o of e){const e=o.slice(t).replace(/\\/g,"/");if(m(o,l)||m(o,r))s[e]=n.default.readFileSync(o,{encoding:"utf8"});else{const t=n.default.readFileSync(o);s[e]=Buffer.from(t).toString("base64"),console.log("packageToDatajs",o)}}return console.log("packageToDatajs file total count",e.length),JSON.stringify(s)}(j,A);n.default.writeFileSync(`${S.dest}/data.js`,"assetsPackage="+e,{encoding:"utf8"})}},exports.unload=function(){console.log(`[${a}] Unload cocos plugin example in builder.`)};